{% extends '@Cms/Layout/layout.twig' %}

{% set widget_title = 'Customer Approve Process State Machine' %}

{% block head_title widget_title %}
{% block section_title widget_title %}

{% block content %}
    <a href="/customer-approve-process/state-machine-items/add-item">Add item</a>  <br />
    <table class="table table-striped table-bordered table-hover gui-table-data dataTable">
        <tr>
            <th>Id</th>
            <th>Customer Name</th>
            <th>Customer Email</th>
            <th>State Machine Name</th>
            <th>Process Name</th>
            <th>State</th>
            <th>Trigger</th>
            <td>Action</td>
        </tr>
    {% for customerApproveProcessItem in customerApproveProcessItems %}
        <tr>
            <td>{{ customerApproveProcessItem.idCustomerApproveProcessItem }}</td>
            <td>
                <a href="{{ url('/customer/view', { 'id-customer' : customerApproveProcessItem.idCustomer }) }}">
                    {{ customerApproveProcessItem.customerName }}
                </a>
            </td>
            <td>{{ customerApproveProcessItem.customerEmail }}</td>
            <td>{{ customerApproveProcessItem.stateMachineItem.stateMachineName }}</td>
            <td>{{ customerApproveProcessItem.stateMachineItem.processName }}</td>
            <td>
                {% if stateMachineItems | length > 0 and stateMachineItems[customerApproveProcessItem.idCustomerApproveProcessItem] is defined %}
                    <a href="{{ url(
                      '/state-machine/graph/drawItem',
                      {
                          process: stateMachineItems[customerApproveProcessItem.idCustomerApproveProcessItem].getProcessName,
                          'state-machine': stateMachineItems[customerApproveProcessItem.idCustomerApproveProcessItem].getStateMachineName,
                          'highlight-state' : stateMachineItems[customerApproveProcessItem.idCustomerApproveProcessItem].getStateName
                      }) }}"
                    >
                        {{ stateMachineItems[customerApproveProcessItem.idCustomerApproveProcessItem].getStateName }}
                    </a>
                {% endif %}
                {% if customerApproveProcessItem.stateHistory | length > 1 %}
                    <div id="history_details_{{ customerApproveProcessItem.idCustomerApproveProcessItem }}">
                        {% for stateHistory in customerApproveProcessItem.stateHistory | slice(1) %}
                            <div>{{ stateHistory.stateName }} ({{ stateHistory.createdAt | formatDateTime }})</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </td>
            <td>
                {% if manualEvents | length > 0 and manualEvents[customerApproveProcessItem.idCustomerApproveProcessItem] is defined %}
                    {% for event in manualEvents[customerApproveProcessItem.idCustomerApproveProcessItem] %}
                        <a class="btn btn-primary btn-sm trigger-order-single-event"
                           href="{{ url('/state-machine/trigger/trigger-event',
                           {
                               'event' : event,
                               'identifier': customerApproveProcessItem.idCustomerApproveProcessItem,
                               'id-state' : customerApproveProcessItem.stateMachineItem.idItemState,
                               redirect : '/customer-approve-process/state-machine-items/list'
                           }) }}"
                        >
                            {{ event }}
                        </a>
                    {% endfor %}
                {% else -%}
                    No manual events
                {%- endif %}
            </td>
            <td>
                <a href="{{ url('/customer-approve-process/state-machine-items/delete-item', { id : customerApproveProcessItem.idCustomerApproveProcessItem }) }}">
                    Delete
                </a>
            </td>
        </tr>
    {% endfor %}
    </table>
{% endblock %}
